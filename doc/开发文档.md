# FastGPT SSO 开发文档

## 项目概述

FastGPT SSO 是一个单点登录（Single Sign-On）服务，为 FastGPT 系统提供统一的身份认证和用户管理功能。该项目支持多种身份提供商集成，包括 LCFC、HK 等。

## 支持的身份提供商

根据 `src/userPrefix.ts` 中定义的枚举，系统支持以下身份提供商：

- **WECOM**: 企业微信
- **FEISHU**: 飞书
- **DINGTALK**: 钉钉
- **JINTIAN**: 今天
- **QILU**: 齐鲁
- **MRL**: MRL
- **HK**: HK 系统
- **LCFC**: LCFC 系统

## 项目架构

```
src/
├── index.ts              # 应用程序入口点
├── controllers.ts         # 控制器层，处理HTTP请求
├── services/             # 业务逻辑层
│   ├── FastGPTUserService.ts    # FastGPT用户数据服务
│   └── IncrementalUserService.ts # 增量用户管理服务
├── database/             # 数据访问层
│   ├── connection.ts     # 数据库连接管理
│   ├── index.ts          # 数据库模块统一导出
│   └── model/
│       └── incrementalUser.ts   # 增量用户数据模型
├── provider/             # 身份提供商集成
│   └── lcfc.ts          # LCFC提供商实现
└── type.ts              # TypeScript类型定义
```

## 核心模块详解

### 1. 应用程序入口 (src/index.ts)

**功能描述：**
- 应用程序的主入口点
- 初始化Express服务器和中间件
- 配置路由和API端点
- 管理应用程序生命周期

**主要功能：**
- **数据库初始化**：建立MongoDB连接
- **服务器初始化**：配置Express应用，设置中间件
- **路由配置**：定义OAuth、SAML和用户管理API端点
- **生命周期管理**：处理服务器启动和关闭事件

**关键API端点：**
```typescript
// OAuth2.0 认证流程
GET  /login/oauth/getAuthURL     # 获取授权URL
GET  /login/oauth/getUserInfo    # 获取用户信息
GET  /login/oauth/callback       # 处理回调

// SAML2.0 认证流程
GET  /login/saml/metadata.xml    # 获取SAML元数据
POST /login/saml/assert          # 处理SAML断言

// 用户管理API
GET  /user/list                  # 获取用户列表（需认证）
GET  /org/list                   # 获取组织列表（需认证）
GET  /user/all/list              # 获取全量用户数据
POST /user/incremental           # 增量用户数据接口
```

**环境变量配置：**
- `PORT`: 服务端口（默认3000）
- `SSO_PROVIDER`: 身份提供商类型
- `MONGODB_URI`: MongoDB连接字符串

### 2. 控制器层 (src/controllers.ts)

**功能描述：**
控制器层负责处理HTTP请求，调用相应的业务逻辑，并返回响应。实现了完整的OAuth2.0和SAML2.0认证流程。

**主要控制器函数：**

#### OAuth2.0 相关控制器
- `getAuthUrl`: 生成OAuth授权URL
- `oauthCallback`: 处理OAuth回调
- `getUserInfo`: 获取用户信息

#### SAML2.0 相关控制器
- `samlMetadata`: 返回SAML元数据
- `samlAssert`: 处理SAML断言

#### 用户管理控制器
- `getUserList`: 获取用户列表（通过provider）
- `getOrgList`: 获取组织列表（通过provider）
- `getAllUserList`: 获取全量用户数据（从数据库）
- `getIncrementalUsers`: 处理增量用户数据

**错误处理：**
所有控制器都包含完善的错误处理机制，返回标准化的JSON响应格式。

### 3. 数据库层 (src/database/)

数据库相关的所有功能，包括：
- **连接管理** (connection.ts): DatabaseConnection 类管理 MongoDB 连接
- **数据模型** (model/incrementalUser.ts): 增量用户的 Mongoose 模型
- **统一导出** (index.ts): 提供数据库连接、模型和服务的统一入口
- **数据库操作函数**: checkTableExists、ensureTablesAndIndexes、initializeDatabase 等

#### 3.1 数据库连接管理 (connection.ts)

**功能描述：**
使用单例模式管理MongoDB连接，确保应用程序中只有一个数据库连接实例。

**主要特性：**
- **单例模式**：确保全局唯一的数据库连接
- **连接池管理**：配置连接池大小和超时设置
- **自动重连**：监听连接事件，处理断线重连
- **优雅关闭**：提供安全的连接关闭方法

**配置参数：**
```typescript
{
  maxPoolSize: 10,                    // 最大连接池大小
  serverSelectionTimeoutMS: 5000,     // 服务器选择超时
  socketTimeoutMS: 45000,             // Socket超时
  bufferCommands: false               // 禁用命令缓冲
}
```

#### 3.2 数据库模块统一导出 (index.ts)

**功能描述：**
提供数据库相关模块的统一入口，包括连接管理、模型定义和服务类。

**主要功能：**
- **模块导出**：统一导出数据库连接、模型和服务
- **表检查**：检查数据库表是否存在
- **索引管理**：确保必要的索引存在
- **初始化流程**：提供完整的数据库初始化流程

**核心函数：**
- `initializeDatabase()`: 初始化数据库连接和表结构
- `closeDatabaseConnection()`: 关闭数据库连接
- `checkTableExists()`: 检查指定表是否存在
- `ensureTablesAndIndexes()`: 确保表和索引存在

#### 3.3 增量用户模型 (model/incrementalUser.ts)

**功能描述：**
定义增量用户的数据模型和数据库Schema，用于存储通过API接口添加的用户数据。

**数据结构：**
```typescript
interface IncrementalUserData {
  username: string;      // 用户名（唯一）
  memberName: string;    // 显示名称
  avatar: string;        // 头像URL
  contact: string;       // 联系方式
  orgs: Array<string>;   // 所属组织列表
}
```

**Schema特性：**
- **唯一索引**：username字段具有唯一约束
- **自动时间戳**：自动添加createdAt和updatedAt字段
- **集合名称**：存储在incremental_users集合中
- **索引优化**：在username和memberName字段上建立索引

### 4. 服务层 (src/services/)

业务逻辑处理层，包含：
- **FastGPT用户服务** (FastGPTUserService.ts): 从 FastGPT 数据库获取用户数据并转换格式
- **增量用户服务** (IncrementalUserService.ts): 增量用户的数据库操作（CRUD）

#### 4.1 FastGPT用户服务 (FastGPTUserService.ts)

**功能描述：**
负责从FastGPT数据库获取用户数据，并将其转换为标准化的lcfcUser格式。支持增量和非增量用户数据的统一处理。

**主要方法：**

##### `getUserList(isIncremental: boolean)`
- 从FastGPT数据库获取用户列表
- 执行复杂的联合查询（team_members + users + teams）
- 只返回活跃状态的用户
- 转换数据格式为lcfcUser

##### `getIncrementalUsers()`
- 获取增量用户表中的所有用户
- 转换为lcfcUser格式
- 标记为增量用户类型

##### `getIncrementalUsersSso()`
- 获取增量用户的SSO格式数据
- 返回IncrementalUserData格式
- 用于与外部系统集成

##### `getAllUsers()`
- 合并常规用户和增量用户
- 返回完整的用户列表
- 并行查询提高性能

**数据转换逻辑：**
- **用户名处理**：移除用户名前缀（如"LCFC-"）
- **状态映射**：将内部状态转换为标准状态
- **时间格式化**：统一时间格式为YYYY-MM-DD
- **类型标识**：区分增量和非增量用户

#### 4.2 增量用户服务 (IncrementalUserService.ts)

**功能描述：**
提供增量用户的完整CRUD操作，包括用户存在性检查、创建、更新和删除功能。

**主要方法：**

##### `checkUserExists(userName: string)`
- 检查指定用户名的用户是否存在
- 返回布尔值结果
- 用于防止重复创建用户

##### `addIncrementalUser(userData: IncrementalUserData)`
- 添加新的增量用户
- 自动检查用户是否已存在
- 防止重复创建，抛出明确错误信息

##### `updateUser(userName: string, userData: Partial<IncrementalUserData>)`
- 更新现有用户信息
- 支持部分字段更新
- 检查用户存在性，不存在则抛出错误

##### `deleteUser(userName: string)`
- 删除指定用户
- 检查用户存在性
- 返回删除操作结果

**错误处理：**
- 统一的错误处理机制
- 详细的错误信息
- 操作失败时的回滚处理

### 5. 身份提供商 (src/provider/)

身份提供商集成实现，目前支持：
- **LCFC提供商** (lcfc.ts): LCFC系统的OAuth2.0集成实现
- **HK提供商** (hk.ts): HK系统的OAuth2.0集成实现

#### 5.1 LCFC提供商 (lcfc.ts)

**功能描述：**
LCFC（龙城未来中心）身份提供商的具体实现，支持OAuth2.0认证流程和用户/组织数据获取。

**主要功能：**

#### OAuth2.0 认证流程
- `lcfc_oauth2_redirectFn`: 生成OAuth授权URL
- `lcfc_oauth2_getUserInfo`: 通过授权码获取用户信息

#### 数据获取接口
- `lcfc_getUserList`: 获取用户列表（合并HCP和增量数据）
- `lcfc_getOrgList`: 获取组织架构列表

**环境变量配置：**
```typescript
// OAuth2.0 配置
OAUTH2_AUTHORIZE_URL    # 授权URL
OAUTH2_TOKEN_URL        # 令牌URL
OAUTH2_USER_INFO_URL    # 用户信息URL
OAUTH2_CLIENT_ID        # 客户端ID
OAUTH2_CLIENT_SECRET    # 客户端密钥

// 字段映射配置
OAUTH2_USERNAME_MAP     # 用户名字段映射
OAUTH2_AVATAR_MAP       # 头像字段映射
OAUTH2_MEMBER_NAME_MAP  # 显示名称字段映射
OAUTH2_CONTACT_MAP      # 联系方式字段映射

// HCP系统配置
USERAUTHCODE           # 用户接口授权码
USERCODE               # 用户接口代码
ORGAUTHCODE            # 组织接口授权码
ORGCODE                # 组织接口代码
BASEURL                # HCP系统基础URL
HCPADMIN               # HCP管理员用户名
HCPPASSWORD            # HCP管理员密码
```

**数据合并逻辑：**
`lcfc_getUserList`函数实现了HCP系统用户和增量用户的数据合并：
1. 从增量用户表获取数据
2. 从HCP系统API获取用户数据
3. 统一数据格式并合并
4. 返回完整的用户列表

### 6. 类型定义 (src/type.ts)

**功能描述：**
定义了项目中使用的所有TypeScript类型和接口，确保类型安全和代码可维护性。

**主要类型定义：**

#### 函数类型
```typescript
type RedirectFn         # OAuth重定向函数类型
type GetUserInfoFn      # 获取用户信息函数类型
type CallbackFn         # OAuth回调函数类型
type AssertFn           # SAML断言函数类型
type GetMetaDataFn      # SAML元数据函数类型
type GetOrgListFn       # 获取组织列表函数类型
type GetUserListFn      # 获取用户列表函数类型
```

#### 数据类型
```typescript
type lcfcUser           # LCFC用户数据类型
type LcfcUserListType   # LCFC用户列表类型
type UserListType       # 用户列表类型
type OrgListType        # 组织列表类型
```

#### lcfcUser 数据结构
```typescript
type lcfcUser = {
  name: string;         // 用户姓名
  acctName: string;     // 账户名称
  key: string;          // 用户标识
  status: string;       // 用户状态
  isPublic: string;     // 是否公开
  isPartners: string;   # 是否合作伙伴
  period: string;       // 有效期
  createTime: string;   // 创建时间
  disableTime: string;  // 禁用时间
};
```

## API接口文档

### 认证接口

#### 1. 获取OAuth授权URL
```http
GET /login/oauth/getAuthURL
```

**请求参数：**
- `redirect_uri` (required): 回调URL
- `state` (optional): 状态参数

**响应格式：**
```json
{
  "success": true,
  "message": "",
  "authURL": "https://..."
}
```

#### 2. 获取用户信息
```http
GET /login/oauth/getUserInfo
```

**请求参数：**
- `code` (required): 授权码

**响应格式：**
```json
{
  "success": true,
  "message": "",
  "username": "user123",
  "avatar": "https://...",
  "memberName": "张三",
  "contact": "13800138000"
}
```

### 用户管理接口

#### 3. 获取用户列表
```http
GET /user/list
```

**认证要求：** 需要Bearer Token

**响应格式：**
```json
{
  "success": true,
  "message": "",
  "userList": [
    {
      "username": "user123",
      "memberName": "张三",
      "avatar": "https://...",
      "contact": "13800138000",
      "orgs": ["dept001"]
    }
  ]
}
```

#### 4. 增量用户接口
```http
POST /user/incremental
```

**请求体：**
```json
{
  "name": "张三",
  "userName": "zhangsan",
  "email": "zhangsan@example.com",
  "mobile": "13800138000",
  "deptCode": "dept001",
  "isquit": "0"
}
```

**响应格式：**
```json
{
  "code": 1000,
  "msg": "增量用户记录添加成功"
}
```

## 部署和配置

### 环境变量配置

创建 `.env` 文件并配置以下变量：

```bash
# 服务配置
PORT=3000
SSO_PROVIDER=lcfc
HOSTNAME=https://your-domain.com

# 数据库配置
MONGODB_URI=mongodb://localhost:27017/fastgpt

# OAuth2.0 配置
OAUTH2_AUTHORIZE_URL=https://auth.example.com/oauth/authorize
OAUTH2_TOKEN_URL=https://auth.example.com/oauth/token
OAUTH2_USER_INFO_URL=https://auth.example.com/api/user
OAUTH2_CLIENT_ID=your_client_id
OAUTH2_CLIENT_SECRET=your_client_secret
OAUTH2_SCOPE=read:user

# 字段映射
OAUTH2_USERNAME_MAP=username
OAUTH2_AVATAR_MAP=avatar_url
OAUTH2_MEMBER_NAME_MAP=name
OAUTH2_CONTACT_MAP=email

# HCP系统配置
BASEURL=http://esbprd.lcfuturecenter.com:8888
USERAUTHCODE=your_user_auth_code
USERCODE=your_user_code
ORGAUTHCODE=your_org_auth_code
ORGCODE=your_org_code
HCPADMIN=hcpadmin
HCPPASSWORD=hcp.admin
```

### 启动应用

```bash
# 安装依赖
npm install

# 开发模式
npm run dev

# 生产模式
npm run build
npm start
```

### Docker部署

```dockerfile
# 使用项目根目录的Dockerfile
docker build -t fastgpt-sso .
docker run -p 3000:3000 --env-file .env fastgpt-sso
```

## 开发指南

### 添加新的身份提供商

1. 在 `src/provider/` 目录下创建新的提供商文件
2. 实现必要的接口函数：
   - `redirectFn`: OAuth重定向
   - `getUserInfo`: 获取用户信息
   - `getUserList`: 获取用户列表（可选）
   - `getOrgList`: 获取组织列表（可选）

3. 在 `src/provider/index.ts` 中注册新提供商
4. 更新环境变量配置

### 扩展数据模型

1. 修改 `src/database/model/` 下的相关模型文件
2. 更新对应的TypeScript类型定义
3. 修改服务层的数据转换逻辑
4. 更新API接口文档

### 测试

```bash
# 运行测试
npm test

# 测试覆盖率
npm run test:coverage
```

## 故障排除

### 常见问题

1. **数据库连接失败**
   - 检查MongoDB服务是否运行
   - 验证MONGODB_URI配置
   - 检查网络连接和防火墙设置

2. **OAuth认证失败**
   - 验证客户端ID和密钥
   - 检查回调URL配置
   - 确认授权服务器可访问性

3. **用户数据同步问题**
   - 检查HCP系统API可访问性
   - 验证认证凭据
   - 查看应用日志获取详细错误信息

### 日志分析

应用使用console.log输出关键操作日志，包括：
- 数据库连接状态
- API请求和响应
- 错误信息和堆栈跟踪

建议在生产环境中使用专业的日志管理工具（如ELK Stack）进行日志收集和分析。

## 安全考虑

1. **敏感信息保护**
   - 所有敏感配置通过环境变量管理
   - 不在代码中硬编码密钥和密码
   - 使用HTTPS传输敏感数据

2. **访问控制**
   - 实现基于Token的认证机制
   - 对敏感API端点进行权限验证
   - 定期轮换API密钥

3. **数据验证**
   - 对所有输入数据进行验证
   - 防止SQL注入和XSS攻击
   - 实现请求频率限制

## 性能优化

1. **数据库优化**
   - 合理设计索引策略
   - 使用连接池管理数据库连接
   - 实现查询结果缓存

2. **API优化**
   - 实现并行查询减少响应时间
   - 使用分页处理大量数据
   - 压缩响应数据

3. **监控和告警**
   - 监控应用性能指标
   - 设置关键指标告警
   - 定期进行性能测试

---

本文档将随着项目的发展持续更新，如有疑问请联系开发团队。