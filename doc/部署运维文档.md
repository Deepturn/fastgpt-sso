# FastGPT SSO 部署运维文档

## 概述

本文档详细介绍了 FastGPT SSO 系统的部署、配置和运维管理流程，包括开发环境搭建、生产环境部署、监控告警和故障处理等内容。

## 系统要求

### 硬件要求

#### 最小配置
- **CPU**: 2核心
- **内存**: 4GB RAM
- **存储**: 20GB 可用空间
- **网络**: 100Mbps 带宽

#### 推荐配置
- **CPU**: 4核心或更多
- **内存**: 8GB RAM 或更多
- **存储**: 100GB SSD
- **网络**: 1Gbps 带宽

### 软件要求

#### 基础环境
- **操作系统**: Linux (Ubuntu 20.04+ / CentOS 7+) / macOS / Windows
- **Bun**: 最新版本 (运行时和包管理器)
- **MongoDB**: 5.0+ (推荐 6.0+)

#### 可选组件
- **Docker**: 20.10+ (容器化部署)
- **Docker Compose**: 2.0+ (编排工具)
- **Nginx**: 1.18+ (反向代理)
- **PM2**: 5.0+ (进程管理)

## 环境配置

### 1. 开发环境搭建

#### 1.1 安装 Bun

```bash
# 安装 Bun
curl -fsSL https://bun.sh/install | bash
source ~/.bashrc

# 验证安装
bun --version
```

#### 1.2 安装 MongoDB

**Ubuntu/Debian:**
```bash
# 导入公钥
wget -qO - https://www.mongodb.org/static/pgp/server-6.0.asc | sudo apt-key add -

# 添加源
echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/6.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-6.0.list

# 安装
sudo apt-get update
sudo apt-get install -y mongodb-org

# 启动服务
sudo systemctl start mongod
sudo systemctl enable mongod
```

**macOS:**
```bash
# 使用 Homebrew
brew tap mongodb/brew
brew install mongodb-community@6.0

# 启动服务
brew services start mongodb/brew/mongodb-community
```

#### 1.3 克隆项目

```bash
# 克隆代码库
git clone <repository-url>
cd fastgpt-sso

# 安装依赖
bun install
```

#### 1.4 环境变量配置

创建 `.env` 文件：

```bash
cp .env.example .env
```

编辑 `.env` 文件：

```bash
# 服务配置
PORT=3000
NODE_ENV=development
SSO_PROVIDER=lcfc
HOSTNAME=http://localhost:3000

# 数据库配置
MONGODB_URI=mongodb://localhost:27017/fastgpt_sso_dev

# OAuth2.0 配置
OAUTH2_AUTHORIZE_URL=https://auth.example.com/oauth/authorize
OAUTH2_TOKEN_URL=https://auth.example.com/oauth/token
OAUTH2_USER_INFO_URL=https://auth.example.com/api/user
OAUTH2_CLIENT_ID=your_dev_client_id
OAUTH2_CLIENT_SECRET=your_dev_client_secret
OAUTH2_SCOPE=read:user

# 字段映射配置
OAUTH2_USERNAME_MAP=username
OAUTH2_AVATAR_MAP=avatar_url
OAUTH2_MEMBER_NAME_MAP=name
OAUTH2_CONTACT_MAP=email

# HCP系统配置 (LCFC提供商)
BASEURL=http://esbprd.lcfuturecenter.com:8888
USERAUTHCODE=your_user_auth_code
USERCODE=your_user_code
ORGAUTHCODE=your_org_auth_code
ORGCODE=your_org_code
HCPADMIN=hcpadmin
HCPPASSWORD=hcp.admin

# 日志配置
LOG_LEVEL=debug
LOG_FILE=logs/app.log
```

#### 1.5 启动开发服务

```bash
# 开发模式启动
bun run dev

# 或使用 Bun 监听模式
bun --watch src/index.ts

# 验证服务
curl http://localhost:3000/test
```

### 2. 生产环境配置

#### 2.1 服务器准备

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装必要工具
sudo apt install -y curl wget git build-essential

# 创建应用用户
sudo useradd -m -s /bin/bash sso
sudo usermod -aG sudo sso
```

#### 2.2 安装运行时环境

```bash
# 安装 Bun (生产版本)
curl -fsSL https://bun.sh/install | bash

# 安装 PM2 (进程管理器)
bun add -g pm2

# 安装 MongoDB
# (参考开发环境安装步骤)
```

#### 2.3 应用部署

```bash
# 切换到应用用户
sudo su - sso

# 创建应用目录
mkdir -p /home/sso/apps
cd /home/sso/apps

# 克隆代码
git clone <repository-url> fastgpt-sso
cd fastgpt-sso

# 安装依赖 (生产模式)
bun install --production

# 构建应用
bun run build
```

#### 2.4 生产环境变量

创建生产环境配置文件 `.env.production`：

```bash
# 服务配置
PORT=3000
NODE_ENV=production
SSO_PROVIDER=lcfc
HOSTNAME=https://sso.yourdomain.com

# 数据库配置
MONGODB_URI=mongodb://sso_user:secure_password@localhost:27017/fastgpt_sso?authSource=admin

# OAuth2.0 配置 (生产环境)
OAUTH2_AUTHORIZE_URL=https://auth.production.com/oauth/authorize
OAUTH2_TOKEN_URL=https://auth.production.com/oauth/token
OAUTH2_USER_INFO_URL=https://auth.production.com/api/user
OAUTH2_CLIENT_ID=prod_client_id
OAUTH2_CLIENT_SECRET=prod_client_secret

# 安全配置
JWT_SECRET=your_super_secure_jwt_secret
ENCRYPT_KEY=your_encryption_key

# 日志配置
LOG_LEVEL=info
LOG_FILE=/var/log/fastgpt-sso/app.log
```

## 部署方式

### 1. 传统部署 (PM2)

#### 1.1 PM2 配置

创建 `ecosystem.config.js`：

```javascript
module.exports = {
  apps: [{
    name: 'fastgpt-sso',
    script: './dist/index.js',
    instances: 'max', // 使用所有CPU核心
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'development',
      PORT: 3000
    },
    env_production: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    log_file: './logs/combined.log',
    out_file: './logs/out.log',
    error_file: './logs/error.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
    merge_logs: true,
    max_memory_restart: '1G',
    node_args: '--max-old-space-size=1024'
  }]
};
```

#### 1.2 启动服务

```bash
# 启动生产环境
pm2 start ecosystem.config.js --env production

# 查看状态
pm2 status

# 查看日志
pm2 logs fastgpt-sso

# 重启服务
pm2 restart fastgpt-sso

# 停止服务
pm2 stop fastgpt-sso

# 设置开机自启
pm2 startup
pm2 save
```

### 2. Docker 部署

#### 2.1 Dockerfile

项目根目录已包含 `Dockerfile`：

```dockerfile
FROM oven/bun:1-alpine

# 设置工作目录
WORKDIR /app

# 复制依赖文件
COPY package.json bun.lockb ./

# 安装依赖
RUN bun install --production

# 复制源代码
COPY . .

# 构建应用
RUN bun run build

# 暴露端口
EXPOSE 3000

# 启动应用
CMD ["bun", "start"]
```

#### 2.2 Docker Compose

创建 `docker-compose.yml`：

```yaml
version: '3.8'

services:
  fastgpt-sso:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - MONGODB_URI=mongodb://mongo:27017/fastgpt_sso
    depends_on:
      - mongo
    restart: unless-stopped
    volumes:
      - ./logs:/app/logs
    networks:
      - sso-network

  mongo:
    image: mongo:6.0
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD=secure_password
      - MONGO_INITDB_DATABASE=fastgpt_sso
    volumes:
      - mongo-data:/data/db
      - ./mongo-init:/docker-entrypoint-initdb.d
    restart: unless-stopped
    networks:
      - sso-network

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - fastgpt-sso
    restart: unless-stopped
    networks:
      - sso-network

volumes:
  mongo-data:

networks:
  sso-network:
    driver: bridge
```

#### 2.3 部署命令

```bash
# 构建并启动
docker-compose up -d

# 查看状态
docker-compose ps

# 查看日志
docker-compose logs -f fastgpt-sso

# 重启服务
docker-compose restart fastgpt-sso

# 停止服务
docker-compose down

# 更新部署
docker-compose pull
docker-compose up -d
```

### 3. Kubernetes 部署

#### 3.1 部署清单

创建 `k8s/deployment.yaml`：

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fastgpt-sso
  labels:
    app: fastgpt-sso
spec:
  replicas: 3
  selector:
    matchLabels:
      app: fastgpt-sso
  template:
    metadata:
      labels:
        app: fastgpt-sso
    spec:
      containers:
      - name: fastgpt-sso
        image: fastgpt-sso:latest
        ports:
        - containerPort: 3000
        env:
        - name: NODE_ENV
          value: "production"
        - name: MONGODB_URI
          valueFrom:
            secretKeyRef:
              name: sso-secrets
              key: mongodb-uri
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /test
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /test
            port: 3000
          initialDelaySeconds: 5
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: fastgpt-sso-service
spec:
  selector:
    app: fastgpt-sso
  ports:
  - protocol: TCP
    port: 80
    targetPort: 3000
  type: LoadBalancer
```

#### 3.2 配置管理

创建 `k8s/configmap.yaml`：

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: sso-config
data:
  PORT: "3000"
  NODE_ENV: "production"
  SSO_PROVIDER: "lcfc"
  LOG_LEVEL: "info"
---
apiVersion: v1
kind: Secret
metadata:
  name: sso-secrets
type: Opaque
data:
  mongodb-uri: <base64-encoded-uri>
  oauth-client-secret: <base64-encoded-secret>
  jwt-secret: <base64-encoded-jwt-secret>
```

#### 3.3 部署命令

```bash
# 应用配置
kubectl apply -f k8s/configmap.yaml

# 部署应用
kubectl apply -f k8s/deployment.yaml

# 查看状态
kubectl get pods -l app=fastgpt-sso
kubectl get services

# 查看日志
kubectl logs -f deployment/fastgpt-sso

# 扩缩容
kubectl scale deployment fastgpt-sso --replicas=5
```

## 反向代理配置

### Nginx 配置

创建 `/etc/nginx/sites-available/fastgpt-sso`：

```nginx
server {
    listen 80;
    server_name sso.yourdomain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name sso.yourdomain.com;

    # SSL 配置
    ssl_certificate /etc/nginx/ssl/sso.yourdomain.com.crt;
    ssl_certificate_key /etc/nginx/ssl/sso.yourdomain.com.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # 安全头
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # 日志配置
    access_log /var/log/nginx/sso_access.log;
    error_log /var/log/nginx/sso_error.log;

    # 代理配置
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # 超时配置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 静态文件缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # 健康检查
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
```

启用配置：

```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/fastgpt-sso /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重载配置
sudo systemctl reload nginx
```

## 监控和日志

### 1. 应用监控

#### 1.1 PM2 监控

```bash
# 安装 PM2 监控
npm install -g @pm2/io

# 启用监控
pm2 install pm2-server-monit

# 查看监控面板
pm2 monit
```

#### 1.2 健康检查端点

在应用中添加健康检查：

```javascript
// 健康检查路由
app.get('/health', (req, res) => {
  const health = {
    uptime: process.uptime(),
    message: 'OK',
    timestamp: Date.now(),
    checks: {
      database: 'OK', // 检查数据库连接
      memory: process.memoryUsage(),
      cpu: process.cpuUsage()
    }
  };
  
  res.status(200).json(health);
});
```

### 2. 日志管理

#### 2.1 日志配置

安装日志库：

```bash
npm install winston winston-daily-rotate-file
```

配置日志：

```javascript
const winston = require('winston');
const DailyRotateFile = require('winston-daily-rotate-file');

const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  transports: [
    new winston.transports.Console({
      format: winston.format.simple()
    }),
    new DailyRotateFile({
      filename: 'logs/application-%DATE%.log',
      datePattern: 'YYYY-MM-DD',
      maxSize: '20m',
      maxFiles: '14d'
    }),
    new DailyRotateFile({
      filename: 'logs/error-%DATE%.log',
      datePattern: 'YYYY-MM-DD',
      level: 'error',
      maxSize: '20m',
      maxFiles: '30d'
    })
  ]
});
```

#### 2.2 日志轮转

配置 logrotate：

```bash
# 创建配置文件
sudo vim /etc/logrotate.d/fastgpt-sso
```

```
/var/log/fastgpt-sso/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 0644 sso sso
    postrotate
        pm2 reloadLogs
    endscript
}
```

### 3. 性能监控

#### 3.1 系统监控

安装监控工具：

```bash
# 安装 htop
sudo apt install htop

# 安装 iotop
sudo apt install iotop

# 安装 nethogs
sudo apt install nethogs
```

#### 3.2 数据库监控

```javascript
// MongoDB 监控脚本
const mongoose = require('mongoose');

setInterval(async () => {
  try {
    const stats = await mongoose.connection.db.stats();
    console.log('数据库统计:', {
      collections: stats.collections,
      dataSize: stats.dataSize,
      indexSize: stats.indexSize,
      connections: mongoose.connection.readyState
    });
  } catch (error) {
    console.error('获取数据库统计失败:', error);
  }
}, 60000); // 每分钟检查一次
```

## 备份和恢复

### 1. 数据库备份

#### 1.1 自动备份脚本

创建 `scripts/backup.sh`：

```bash
#!/bin/bash

# 配置
DB_NAME="fastgpt_sso"
BACKUP_DIR="/backup/mongodb"
DATE=$(date +"%Y%m%d_%H%M%S")
BACKUP_PATH="$BACKUP_DIR/$DATE"

# 创建备份目录
mkdir -p $BACKUP_PATH

# 执行备份
mongodump --db $DB_NAME --out $BACKUP_PATH

# 压缩备份
tar -czf "$BACKUP_PATH.tar.gz" -C $BACKUP_DIR $DATE

# 删除未压缩的备份
rm -rf $BACKUP_PATH

# 保留最近30天的备份
find $BACKUP_DIR -name "*.tar.gz" -mtime +30 -delete

echo "备份完成: $BACKUP_PATH.tar.gz"
```

#### 1.2 定时备份

```bash
# 添加到 crontab
crontab -e

# 每天凌晨2点备份
0 2 * * * /home/sso/scripts/backup.sh >> /var/log/backup.log 2>&1
```

### 2. 应用备份

```bash
#!/bin/bash

# 应用代码备份
APP_DIR="/home/sso/apps/fastgpt-sso"
BACKUP_DIR="/backup/application"
DATE=$(date +"%Y%m%d_%H%M%S")

# 创建备份
tar -czf "$BACKUP_DIR/app_$DATE.tar.gz" \
    --exclude="node_modules" \
    --exclude="logs" \
    --exclude=".git" \
    -C $(dirname $APP_DIR) $(basename $APP_DIR)

echo "应用备份完成: app_$DATE.tar.gz"
```

### 3. 恢复流程

#### 3.1 数据库恢复

```bash
# 停止应用
pm2 stop fastgpt-sso

# 解压备份
tar -xzf /backup/mongodb/20240115_020000.tar.gz -C /tmp

# 恢复数据库
mongorestore --db fastgpt_sso --drop /tmp/20240115_020000/fastgpt_sso

# 启动应用
pm2 start fastgpt-sso
```

#### 3.2 应用恢复

```bash
# 停止应用
pm2 stop fastgpt-sso

# 备份当前版本
mv /home/sso/apps/fastgpt-sso /home/sso/apps/fastgpt-sso.backup

# 恢复应用
tar -xzf /backup/application/app_20240115_020000.tar.gz -C /home/sso/apps/

# 安装依赖
cd /home/sso/apps/fastgpt-sso
bun install --production

# 启动应用
pm2 start fastgpt-sso
```

## 安全配置

### 1. 系统安全

#### 1.1 防火墙配置

```bash
# 启用 UFW
sudo ufw enable

# 允许 SSH
sudo ufw allow ssh

# 允许 HTTP/HTTPS
sudo ufw allow 80
sudo ufw allow 443

# 允许应用端口 (仅本地)
sudo ufw allow from 127.0.0.1 to any port 3000

# 查看状态
sudo ufw status
```

#### 1.2 SSH 安全

编辑 `/etc/ssh/sshd_config`：

```
# 禁用 root 登录
PermitRootLogin no

# 使用密钥认证
PasswordAuthentication no
PubkeyAuthentication yes

# 更改默认端口
Port 2222

# 限制用户
AllowUsers sso
```

重启 SSH 服务：

```bash
sudo systemctl restart sshd
```

### 2. 应用安全

#### 2.1 环境变量保护

```bash
# 设置文件权限
chmod 600 .env
chown sso:sso .env

# 使用 systemd 环境文件
sudo vim /etc/systemd/system/fastgpt-sso.service
```

```ini
[Unit]
Description=FastGPT SSO Service
After=network.target

[Service]
Type=simple
User=sso
WorkingDirectory=/home/sso/apps/fastgpt-sso
EnvironmentFile=/home/sso/apps/fastgpt-sso/.env
ExecStart=/usr/bin/node dist/index.js
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

#### 2.2 数据库安全

```javascript
// MongoDB 用户创建
use admin
db.createUser({
  user: "sso_admin",
  pwd: "secure_password",
  roles: [
    { role: "userAdminAnyDatabase", db: "admin" },
    { role: "readWriteAnyDatabase", db: "admin" }
  ]
});

use fastgpt_sso
db.createUser({
  user: "sso_app",
  pwd: "app_password",
  roles: [
    { role: "readWrite", db: "fastgpt_sso" }
  ]
});
```

## 故障排除

### 1. 常见问题

#### 1.1 服务无法启动

```bash
# 检查端口占用
sudo netstat -tlnp | grep :3000

# 检查进程
ps aux | grep node

# 检查日志
pm2 logs fastgpt-sso
tail -f /var/log/fastgpt-sso/error.log
```

#### 1.2 数据库连接失败

```bash
# 检查 MongoDB 状态
sudo systemctl status mongod

# 检查连接
mongo --eval "db.adminCommand('ismaster')"

# 检查配置
cat /etc/mongod.conf
```

#### 1.3 内存不足

```bash
# 检查内存使用
free -h
top -p $(pgrep -f "fastgpt-sso")

# 增加 swap
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

### 2. 性能问题

#### 2.1 响应慢

```bash
# 检查网络延迟
ping target_server
traceroute target_server

# 检查数据库性能
mongo --eval "db.runCommand({serverStatus: 1})"

# 检查应用性能
pm2 monit
```

#### 2.2 高 CPU 使用率

```bash
# 分析 CPU 使用
top -H -p $(pgrep -f "fastgpt-sso")

# 生成性能报告
node --prof dist/index.js
node --prof-process isolate-*.log > profile.txt
```

### 3. 紧急恢复

#### 3.1 快速回滚

```bash
#!/bin/bash
# 紧急回滚脚本

# 停止当前服务
pm2 stop fastgpt-sso

# 切换到备份版本
cd /home/sso/apps
mv fastgpt-sso fastgpt-sso.failed
mv fastgpt-sso.backup fastgpt-sso

# 启动服务
cd fastgpt-sso
pm2 start ecosystem.config.js --env production

echo "回滚完成"
```

#### 3.2 数据恢复

```bash
#!/bin/bash
# 紧急数据恢复脚本

# 获取最新备份
LATEST_BACKUP=$(ls -t /backup/mongodb/*.tar.gz | head -1)

# 解压并恢复
tar -xzf $LATEST_BACKUP -C /tmp
BACKUP_DIR=$(basename $LATEST_BACKUP .tar.gz)

# 恢复数据库
mongorestore --db fastgpt_sso --drop /tmp/$BACKUP_DIR/fastgpt_sso

echo "数据恢复完成"
```

## 运维检查清单

### 日常检查

- [ ] 服务状态检查
- [ ] 日志文件检查
- [ ] 磁盘空间检查
- [ ] 内存使用检查
- [ ] 数据库连接检查
- [ ] 备份文件检查

### 周期检查

- [ ] 安全更新安装
- [ ] 性能指标分析
- [ ] 备份恢复测试
- [ ] 监控告警测试
- [ ] 文档更新检查

### 月度检查

- [ ] 系统资源规划
- [ ] 安全审计
- [ ] 灾难恢复演练
- [ ] 容量规划评估
- [ ] 运维流程优化

---

本部署运维文档提供了 FastGPT SSO 系统的完整部署和运维指南。在实际使用中，请根据具体环境和需求进行相应调整。如有问题，请及时联系技术团队。