# FastGPT SSO 故障排除指南

## 概述

本文档提供了 FastGPT SSO 系统常见问题的诊断方法和解决方案，帮助开发人员和运维人员快速定位和解决系统故障。

## 故障分类

### 1. 服务启动问题
### 2. 认证授权问题
### 3. 数据库连接问题
### 4. 网络通信问题
### 5. 性能问题
### 6. 配置问题
### 7. 第三方集成问题

---

## 1. 服务启动问题

### 1.1 端口被占用

**症状：**
```
Error: listen EADDRINUSE: address already in use :::3000
```

**诊断步骤：**
```bash
# 检查端口占用
sudo netstat -tlnp | grep :3000
# 或使用 lsof
sudo lsof -i :3000

# 查看进程详情
ps aux | grep <PID>
```

**解决方案：**
```bash
# 方案1: 杀死占用进程
sudo kill -9 <PID>

# 方案2: 更改应用端口
export PORT=3001
# 或修改 .env 文件
echo "PORT=3001" >> .env

# 方案3: 使用 PM2 重启
pm2 restart fastgpt-sso
```

### 1.2 依赖模块缺失

**症状：**
```
Error: Cannot find module 'express'
```

**诊断步骤：**
```bash
# 检查 node_modules 目录
ls -la node_modules/

# 检查 package.json
cat package.json

# 验证 bun 安装
bun pm ls
```

**解决方案：**
```bash
# 重新安装依赖
rm -rf node_modules bun.lockb
bun install

# 清理 bun 缓存
bun pm cache rm

# 如果仍有问题，强制重新安装
bun install --force
```

### 1.3 环境变量未设置

**症状：**
```
Error: MONGODB_URI is not defined
```

**诊断步骤：**
```bash
# 检查环境变量
echo $MONGODB_URI
env | grep MONGODB

# 检查 .env 文件
cat .env
ls -la .env
```

**解决方案：**
```bash
# 创建 .env 文件
cp .env.example .env

# 设置必要的环境变量
echo "MONGODB_URI=mongodb://localhost:27017/fastgpt_sso" >> .env
echo "PORT=3000" >> .env

# 验证配置
source .env
echo $MONGODB_URI
```

### 1.4 权限问题

**症状：**
```
Error: EACCES: permission denied, open '/var/log/app.log'
```

**诊断步骤：**
```bash
# 检查文件权限
ls -la /var/log/app.log

# 检查目录权限
ls -la /var/log/

# 检查当前用户
whoami
id
```

**解决方案：**
```bash
# 创建日志目录
sudo mkdir -p /var/log/fastgpt-sso

# 设置权限
sudo chown -R $USER:$USER /var/log/fastgpt-sso
sudo chmod -R 755 /var/log/fastgpt-sso

# 或使用相对路径
mkdir -p logs
echo "LOG_FILE=./logs/app.log" >> .env
```

---

## 2. 认证授权问题

### 2.1 OAuth2.0 认证失败

**症状：**
```
OAuth2 authentication failed: invalid_client
```

**诊断步骤：**
```bash
# 检查 OAuth2 配置
echo $OAUTH2_CLIENT_ID
echo $OAUTH2_CLIENT_SECRET
echo $OAUTH2_AUTHORIZE_URL

# 测试授权端点
curl -I "$OAUTH2_AUTHORIZE_URL"

# 检查回调 URL
echo $OAUTH2_REDIRECT_URI
```

**解决方案：**
```bash
# 验证客户端凭据
# 1. 检查 client_id 和 client_secret 是否正确
# 2. 确认回调 URL 已在 OAuth2 提供商注册
# 3. 检查授权范围 (scope) 配置

# 测试 token 端点
curl -X POST "$OAUTH2_TOKEN_URL" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=client_credentials&client_id=$OAUTH2_CLIENT_ID&client_secret=$OAUTH2_CLIENT_SECRET"
```

### 2.2 SAML 认证配置错误

**症状：**
```
SAML assertion validation failed
```

**诊断步骤：**
```bash
# 检查 SAML 配置
cat config/saml.json

# 验证证书
openssl x509 -in cert.pem -text -noout

# 检查元数据
curl -s "$SAML_METADATA_URL" | xmllint --format -
```

**解决方案：**
```bash
# 1. 验证 SAML 证书有效性
# 2. 检查 EntityID 配置
# 3. 确认 ACS URL 正确
# 4. 验证属性映射配置

# 重新生成证书 (如需要)
openssl req -x509 -newkey rsa:2048 -keyout key.pem -out cert.pem -days 365 -nodes
```

### 2.3 用户信息获取失败

**症状：**
```
Failed to fetch user info: 401 Unauthorized
```

**诊断步骤：**
```bash
# 检查访问令牌
echo $ACCESS_TOKEN

# 测试用户信息端点
curl -H "Authorization: Bearer $ACCESS_TOKEN" "$OAUTH2_USER_INFO_URL"

# 检查字段映射配置
echo $OAUTH2_USERNAME_MAP
echo $OAUTH2_AVATAR_MAP
```

**解决方案：**
```bash
# 1. 验证访问令牌有效性
# 2. 检查 API 权限范围
# 3. 确认字段映射配置正确
# 4. 验证用户信息端点 URL

# 更新字段映射
echo "OAUTH2_USERNAME_MAP=login" >> .env
echo "OAUTH2_AVATAR_MAP=avatar_url" >> .env
```

---

## 3. 数据库连接问题

### 3.1 MongoDB 连接失败

**症状：**
```
MongoNetworkError: failed to connect to server
```

**诊断步骤：**
```bash
# 检查 MongoDB 服务状态
sudo systemctl status mongod

# 测试连接
mongo --eval "db.adminCommand('ismaster')"

# 检查端口
sudo netstat -tlnp | grep :27017

# 检查配置文件
cat /etc/mongod.conf
```

**解决方案：**
```bash
# 启动 MongoDB 服务
sudo systemctl start mongod
sudo systemctl enable mongod

# 检查绑定地址
sudo vim /etc/mongod.conf
# 确保 bindIp 包含应用服务器 IP

# 重启服务
sudo systemctl restart mongod

# 验证连接
mongosh mongodb://localhost:27017/fastgpt_sso
```

### 3.2 认证失败

**症状：**
```
MongoError: Authentication failed
```

**诊断步骤：**
```bash
# 检查数据库用户
mongo admin --eval "db.getUsers()"

# 测试认证
mongo -u username -p password --authenticationDatabase admin

# 检查连接字符串
echo $MONGODB_URI
```

**解决方案：**
```bash
# 创建数据库用户
mongosh admin
> db.createUser({
    user: "sso_user",
    pwd: "password",
    roles: [{role: "readWrite", db: "fastgpt_sso"}]
  })

# 更新连接字符串
echo "MONGODB_URI=mongodb://sso_user:password@localhost:27017/fastgpt_sso?authSource=admin" > .env
```

### 3.3 集合不存在

**症状：**
```
Collection 'incrementalUsers' not found
```

**诊断步骤：**
```bash
# 手动创建集合
mongosh fastgpt_sso
> show collections
> db.incrementalUsers.find().limit(1)

# 检查数据库初始化
grep -r "ensureTablesAndIndexes" src/
```

**解决方案：**
```bash
# 手动创建集合
mongosh fastgpt_sso
> db.createCollection("incrementalUsers")
> db.incrementalUsers.createIndex({"username": 1}, {"unique": true})

# 或重新初始化数据库
bun run init-db
```

---

## 4. 网络通信问题

### 4.1 外部 API 调用超时

**症状：**
```
Request timeout: ETIMEDOUT
```

**诊断步骤：**
```bash
# 测试网络连通性
ping api.example.com
telnet api.example.com 443

# 检查 DNS 解析
nslookup api.example.com
dig api.example.com

# 测试 HTTP 请求
curl -v --connect-timeout 10 https://api.example.com/test
```

**解决方案：**
```bash
# 增加超时时间
echo "REQUEST_TIMEOUT=30000" >> .env

# 配置代理 (如需要)
echo "HTTP_PROXY=http://proxy.company.com:8080" >> .env
echo "HTTPS_PROXY=http://proxy.company.com:8080" >> .env

# 检查防火墙规则
sudo ufw status
sudo iptables -L
```

### 4.2 SSL/TLS 证书问题

**症状：**
```
Error: unable to verify the first certificate
```

**诊断步骤：**
```bash
# 检查证书
openssl s_client -connect api.example.com:443 -servername api.example.com

# 验证证书链
curl -vI https://api.example.com

# 检查系统证书
ls /etc/ssl/certs/
```

**解决方案：**
```bash
# 更新 CA 证书
sudo apt update && sudo apt install ca-certificates

# 临时禁用证书验证 (仅开发环境)
echo "NODE_TLS_REJECT_UNAUTHORIZED=0" >> .env

# 添加自定义 CA 证书
sudo cp custom-ca.crt /usr/local/share/ca-certificates/
sudo update-ca-certificates
```

### 4.3 跨域问题

**症状：**
```
CORS policy: No 'Access-Control-Allow-Origin' header
```

**诊断步骤：**
```bash
# 检查 CORS 配置
grep -r "cors" src/

# 测试预检请求
curl -X OPTIONS -H "Origin: http://localhost:3000" \
  -H "Access-Control-Request-Method: POST" \
  http://localhost:3000/api/auth
```

**解决方案：**
```javascript
// 配置 CORS 中间件
const cors = require('cors');

app.use(cors({
  origin: process.env.ALLOWED_ORIGINS?.split(',') || ['http://localhost:3000'],
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization']
}));
```

---

## 5. 性能问题

### 5.1 响应时间过长

**症状：**
- API 响应时间超过 5 秒
- 用户界面加载缓慢

**诊断步骤：**
```bash
# 检查应用性能
pm2 monit

# 分析慢查询
mongosh fastgpt_sso
> db.setProfilingLevel(2, {slowms: 100})
> db.system.profile.find().sort({ts: -1}).limit(5)

# 检查系统资源
top
htop
iotop
```

**解决方案：**
```bash
# 1. 数据库优化
mongosh fastgpt_sso
> db.incrementalUsers.createIndex({"username": 1})
> db.incrementalUsers.createIndex({"updatedAt": -1})

# 2. 启用应用缓存
echo "ENABLE_CACHE=true" >> .env
echo "CACHE_TTL=300" >> .env

# 3. 增加进程数
pm2 scale fastgpt-sso 4

# 4. 启用 gzip 压缩
# 在 nginx 配置中添加
# gzip on;
# gzip_types text/plain application/json;
```

### 5.2 内存泄漏

**症状：**
```
FATAL ERROR: Ineffective mark-compacts near heap limit
```

**诊断步骤：**
```bash
# 监控内存使用
ps aux | grep node
top -p $(pgrep -f "fastgpt-sso")

# 生成堆快照
node --inspect dist/index.js
# 在 Chrome DevTools 中分析内存

# 检查内存配置
echo $NODE_OPTIONS
```

**解决方案：**
```bash
# 增加堆内存限制
echo "NODE_OPTIONS=--max-old-space-size=2048" >> .env

# 配置 PM2 内存限制
# 在 ecosystem.config.js 中添加
# max_memory_restart: '1G'

# 重启应用
pm2 restart fastgpt-sso
```

### 5.3 数据库性能问题

**症状：**
- 查询响应时间长
- 数据库 CPU 使用率高

**诊断步骤：**
```bash
# 检查数据库状态
mongosh fastgpt_sso
> db.serverStatus()
> db.stats()

# 分析查询计划
> db.incrementalUsers.find({username: "test"}).explain("executionStats")

# 检查索引使用
> db.incrementalUsers.getIndexes()
```

**解决方案：**
```bash
# 创建复合索引
mongosh fastgpt_sso
> db.incrementalUsers.createIndex({"username": 1, "updatedAt": -1})

# 优化查询
# 使用投影减少数据传输
> db.incrementalUsers.find({}, {username: 1, memberName: 1})

# 启用查询缓存
# 在 mongod.conf 中配置
# queryPlanCacheSizeGB: 1
```

---

## 6. 配置问题

### 6.1 环境变量配置错误

**症状：**
```
Invalid configuration: SSO_PROVIDER must be 'oauth2' or 'saml'
```

**诊断步骤：**
```bash
# 检查所有环境变量
env | grep -E "(SSO|OAUTH|SAML|MONGODB)"

# 验证配置文件
cat .env
cat config/default.json

# 检查配置加载
node -e "console.log(process.env.SSO_PROVIDER)"
```

**解决方案：**
```bash
# 修正配置值
sed -i 's/SSO_PROVIDER=lcfc/SSO_PROVIDER=oauth2/' .env

# 验证必需配置
cat > check-config.js << 'EOF'
const requiredVars = [
  'MONGODB_URI',
  'SSO_PROVIDER',
  'OAUTH2_CLIENT_ID',
  'OAUTH2_CLIENT_SECRET'
];

requiredVars.forEach(varName => {
  if (!process.env[varName]) {
    console.error(`Missing required environment variable: ${varName}`);
    process.exit(1);
  }
});

console.log('Configuration check passed');
EOF

node check-config.js
```

### 6.2 日志配置问题

**症状：**
- 日志文件未生成
- 日志级别不正确

**诊断步骤：**
```bash
# 检查日志配置
echo $LOG_LEVEL
echo $LOG_FILE

# 检查日志目录权限
ls -la logs/

# 测试日志写入
touch logs/test.log
echo "test" > logs/test.log
```

**解决方案：**
```bash
# 创建日志目录
mkdir -p logs
chmod 755 logs

# 设置正确的日志级别
echo "LOG_LEVEL=info" >> .env
echo "LOG_FILE=./logs/app.log" >> .env

# 配置日志轮转
cat > logrotate.conf << 'EOF'
logs/*.log {
  daily
  rotate 7
  compress
  missingok
  notifempty
}
EOF
```

---

## 7. 第三方集成问题

### 7.1 HCP 系统连接失败

**症状：**
```
HCP API request failed: Connection refused
```

**诊断步骤：**
```bash
# 检查 HCP 配置
echo $BASEURL
echo $USERAUTHCODE
echo $USERCODE

# 测试网络连通性
ping esbprd.lcfuturecenter.com
telnet esbprd.lcfuturecenter.com 8888

# 测试 API 端点
curl -v "$BASEURL/api/test"
```

**解决方案：**
```bash
# 验证 HCP 凭据
# 联系 HCP 管理员确认以下信息：
# - BASEURL 是否正确
# - 认证码是否有效
# - 网络访问权限

# 更新配置
echo "BASEURL=http://esbprd.lcfuturecenter.com:8888" >> .env
echo "USERAUTHCODE=correct_auth_code" >> .env

# 测试连接
node -e "require('./src/provider/lcfc').testConnection()"
```

### 7.2 FastGPT 数据库访问问题

**症状：**
```
Failed to fetch FastGPT users: Collection not found
```

**诊断步骤：**
```bash
# 检查 FastGPT 数据库连接
mongosh $FASTGPT_MONGODB_URI
> show collections
> db.users.findOne()

# 验证集合结构
> db.users.findOne({}, {_id: 1, username: 1, avatar: 1})
```

**解决方案：**
```bash
# 确认 FastGPT 数据库配置
echo "FASTGPT_MONGODB_URI=mongodb://localhost:27017/fastgpt" >> .env

# 验证用户集合存在
mongosh fastgpt
> db.users.countDocuments({})

# 检查字段映射
# 确保 FastGPT 用户字段与 SSO 期望字段匹配
```

---

## 诊断工具和脚本

### 1. 系统健康检查脚本

```bash
#!/bin/bash
# health-check.sh

echo "=== FastGPT SSO 健康检查 ==="

# 检查服务状态
echo "1. 检查服务状态..."
if pm2 list | grep -q "fastgpt-sso.*online"; then
    echo "✓ 服务运行正常"
else
    echo "✗ 服务未运行"
fi

# 检查端口
echo "2. 检查端口占用..."
if netstat -tlnp | grep -q ":3000"; then
    echo "✓ 端口 3000 已监听"
else
    echo "✗ 端口 3000 未监听"
fi

# 检查数据库连接
echo "3. 检查数据库连接..."
if mongo --eval "db.adminCommand('ismaster')" >/dev/null 2>&1; then
    echo "✓ 数据库连接正常"
else
    echo "✗ 数据库连接失败"
fi

# 检查 API 响应
echo "4. 检查 API 响应..."
if curl -s http://localhost:3000/test >/dev/null; then
    echo "✓ API 响应正常"
else
    echo "✗ API 无响应"
fi

# 检查磁盘空间
echo "5. 检查磁盘空间..."
DISK_USAGE=$(df / | awk 'NR==2 {print $5}' | sed 's/%//')
if [ $DISK_USAGE -lt 80 ]; then
    echo "✓ 磁盘空间充足 ($DISK_USAGE%)"
else
    echo "⚠ 磁盘空间不足 ($DISK_USAGE%)"
fi

# 检查内存使用
echo "6. 检查内存使用..."
MEM_USAGE=$(free | awk 'NR==2{printf "%.0f", $3*100/$2}')
if [ $MEM_USAGE -lt 80 ]; then
    echo "✓ 内存使用正常 ($MEM_USAGE%)"
else
    echo "⚠ 内存使用过高 ($MEM_USAGE%)"
fi

echo "=== 检查完成 ==="
```

### 2. 日志分析脚本

```bash
#!/bin/bash
# log-analyzer.sh

LOG_FILE="logs/app.log"
ERROR_LOG="logs/error.log"

echo "=== 日志分析报告 ==="

# 错误统计
echo "1. 错误统计 (最近24小时):"
if [ -f "$ERROR_LOG" ]; then
    grep "$(date -d '1 day ago' '+%Y-%m-%d')\|$(date '+%Y-%m-%d')" "$ERROR_LOG" | \
    awk '{print $4}' | sort | uniq -c | sort -nr | head -10
else
    echo "错误日志文件不存在"
fi

# 请求统计
echo "\n2. 请求统计 (最近1小时):"
if [ -f "$LOG_FILE" ]; then
    grep "$(date -d '1 hour ago' '+%Y-%m-%d %H')\|$(date '+%Y-%m-%d %H')" "$LOG_FILE" | \
    grep "HTTP" | awk '{print $7}' | sort | uniq -c | sort -nr | head -10
else
    echo "应用日志文件不存在"
fi

# 性能分析
echo "\n3. 响应时间分析:"
if [ -f "$LOG_FILE" ]; then
    grep "response_time" "$LOG_FILE" | tail -100 | \
    awk '{print $NF}' | awk '{sum+=$1; count++} END {if(count>0) print "平均响应时间:", sum/count "ms"}'
else
    echo "无性能数据"
fi

echo "\n=== 分析完成 ==="
```

### 3. 配置验证脚本

```javascript
// config-validator.js
const fs = require('fs');
const path = require('path');

// 必需的环境变量
const requiredEnvVars = {
  'PORT': { type: 'number', default: 3000 },
  'NODE_ENV': { type: 'string', values: ['development', 'production', 'test'] },
  'MONGODB_URI': { type: 'string', required: true },
  'SSO_PROVIDER': { type: 'string', values: ['oauth2', 'saml', 'lcfc'], required: true }
};

// OAuth2 相关变量
const oauth2Vars = {
  'OAUTH2_CLIENT_ID': { type: 'string', required: true },
  'OAUTH2_CLIENT_SECRET': { type: 'string', required: true },
  'OAUTH2_AUTHORIZE_URL': { type: 'url', required: true },
  'OAUTH2_TOKEN_URL': { type: 'url', required: true }
};

function validateConfig() {
  console.log('=== 配置验证 ===');
  
  let errors = [];
  let warnings = [];
  
  // 检查 .env 文件
  if (!fs.existsSync('.env')) {
    errors.push('.env 文件不存在');
    return { errors, warnings };
  }
  
  // 加载环境变量
  require('dotenv').config();
  
  // 验证必需变量
  Object.entries(requiredEnvVars).forEach(([key, config]) => {
    const value = process.env[key];
    
    if (config.required && !value) {
      errors.push(`缺少必需的环境变量: ${key}`);
      return;
    }
    
    if (value) {
      // 类型验证
      if (config.type === 'number' && isNaN(Number(value))) {
        errors.push(`${key} 必须是数字`);
      }
      
      // 值验证
      if (config.values && !config.values.includes(value)) {
        errors.push(`${key} 的值必须是: ${config.values.join(', ')}`);
      }
      
      // URL 验证
      if (config.type === 'url') {
        try {
          new URL(value);
        } catch {
          errors.push(`${key} 不是有效的 URL`);
        }
      }
    }
  });
  
  // OAuth2 特定验证
  if (process.env.SSO_PROVIDER === 'oauth2') {
    Object.entries(oauth2Vars).forEach(([key, config]) => {
      const value = process.env[key];
      
      if (config.required && !value) {
        errors.push(`OAuth2 模式下缺少必需的环境变量: ${key}`);
      }
    });
  }
  
  // 检查文件权限
  try {
    fs.accessSync('.env', fs.constants.R_OK);
  } catch {
    warnings.push('.env 文件权限可能不正确');
  }
  
  return { errors, warnings };
}

// 运行验证
const { errors, warnings } = validateConfig();

if (errors.length > 0) {
  console.log('\n❌ 配置错误:');
  errors.forEach(error => console.log(`  - ${error}`));
}

if (warnings.length > 0) {
  console.log('\n⚠️  配置警告:');
  warnings.forEach(warning => console.log(`  - ${warning}`));
}

if (errors.length === 0 && warnings.length === 0) {
  console.log('\n✅ 配置验证通过');
}

console.log('\n=== 验证完成 ===');

process.exit(errors.length > 0 ? 1 : 0);
```

---

## 监控和告警

### 1. 基础监控脚本

```bash
#!/bin/bash
# monitor.sh

# 配置
SERVICE_NAME="fastgpt-sso"
ALERT_EMAIL="admin@company.com"
LOG_FILE="/var/log/monitor.log"

# 检查服务状态
check_service() {
    if ! pm2 list | grep -q "$SERVICE_NAME.*online"; then
        echo "$(date): 服务 $SERVICE_NAME 未运行" >> $LOG_FILE
        # 尝试重启
        pm2 restart $SERVICE_NAME
        sleep 10
        
        # 再次检查
        if ! pm2 list | grep -q "$SERVICE_NAME.*online"; then
            echo "服务重启失败" | mail -s "FastGPT SSO 服务告警" $ALERT_EMAIL
        fi
    fi
}

# 检查内存使用
check_memory() {
    MEM_USAGE=$(free | awk 'NR==2{printf "%.0f", $3*100/$2}')
    if [ $MEM_USAGE -gt 90 ]; then
        echo "$(date): 内存使用率过高: $MEM_USAGE%" >> $LOG_FILE
        echo "内存使用率: $MEM_USAGE%" | mail -s "FastGPT SSO 内存告警" $ALERT_EMAIL
    fi
}

# 检查磁盘空间
check_disk() {
    DISK_USAGE=$(df / | awk 'NR==2 {print $5}' | sed 's/%//')
    if [ $DISK_USAGE -gt 85 ]; then
        echo "$(date): 磁盘使用率过高: $DISK_USAGE%" >> $LOG_FILE
        echo "磁盘使用率: $DISK_USAGE%" | mail -s "FastGPT SSO 磁盘告警" $ALERT_EMAIL
    fi
}

# 检查 API 响应
check_api() {
    if ! curl -s --max-time 10 http://localhost:3000/test >/dev/null; then
        echo "$(date): API 无响应" >> $LOG_FILE
        echo "API 健康检查失败" | mail -s "FastGPT SSO API 告警" $ALERT_EMAIL
    fi
}

# 执行所有检查
check_service
check_memory
check_disk
check_api
```

### 2. 性能监控

```javascript
// performance-monitor.js
const os = require('os');
const fs = require('fs');
const mongoose = require('mongoose');

class PerformanceMonitor {
  constructor() {
    this.metrics = {
      cpu: [],
      memory: [],
      database: [],
      requests: []
    };
  }
  
  // 收集系统指标
  collectSystemMetrics() {
    const cpuUsage = process.cpuUsage();
    const memUsage = process.memoryUsage();
    
    this.metrics.cpu.push({
      timestamp: Date.now(),
      user: cpuUsage.user,
      system: cpuUsage.system
    });
    
    this.metrics.memory.push({
      timestamp: Date.now(),
      rss: memUsage.rss,
      heapUsed: memUsage.heapUsed,
      heapTotal: memUsage.heapTotal
    });
  }
  
  // 收集数据库指标
  async collectDatabaseMetrics() {
    try {
      const stats = await mongoose.connection.db.stats();
      this.metrics.database.push({
        timestamp: Date.now(),
        collections: stats.collections,
        dataSize: stats.dataSize,
        indexSize: stats.indexSize,
        connections: mongoose.connection.readyState
      });
    } catch (error) {
      console.error('收集数据库指标失败:', error);
    }
  }
  
  // 记录请求指标
  recordRequest(req, res, responseTime) {
    this.metrics.requests.push({
      timestamp: Date.now(),
      method: req.method,
      url: req.url,
      statusCode: res.statusCode,
      responseTime: responseTime
    });
    
    // 保持最近1000条记录
    if (this.metrics.requests.length > 1000) {
      this.metrics.requests = this.metrics.requests.slice(-1000);
    }
  }
  
  // 生成报告
  generateReport() {
    const now = Date.now();
    const oneHourAgo = now - 60 * 60 * 1000;
    
    // 过滤最近一小时的数据
    const recentRequests = this.metrics.requests.filter(r => r.timestamp > oneHourAgo);
    
    const report = {
      timestamp: new Date().toISOString(),
      requests: {
        total: recentRequests.length,
        avgResponseTime: recentRequests.reduce((sum, r) => sum + r.responseTime, 0) / recentRequests.length || 0,
        errorRate: recentRequests.filter(r => r.statusCode >= 400).length / recentRequests.length || 0
      },
      memory: {
        current: process.memoryUsage(),
        peak: Math.max(...this.metrics.memory.slice(-60).map(m => m.heapUsed))
      },
      database: {
        connections: mongoose.connection.readyState,
        lastStats: this.metrics.database[this.metrics.database.length - 1]
      }
    };
    
    return report;
  }
  
  // 启动监控
  start() {
    // 每分钟收集系统指标
    setInterval(() => {
      this.collectSystemMetrics();
      this.collectDatabaseMetrics();
    }, 60000);
    
    // 每10分钟生成报告
    setInterval(() => {
      const report = this.generateReport();
      console.log('性能报告:', JSON.stringify(report, null, 2));
      
      // 检查告警条件
      if (report.requests.avgResponseTime > 5000) {
        console.warn('告警: 平均响应时间过长');
      }
      
      if (report.requests.errorRate > 0.05) {
        console.warn('告警: 错误率过高');
      }
    }, 600000);
  }
}

module.exports = PerformanceMonitor;
```

---

## 应急响应流程

### 1. 服务完全不可用

**立即响应 (5分钟内):**
1. 确认问题范围
2. 检查服务状态: `pm2 status`
3. 尝试重启服务: `pm2 restart fastgpt-sso`
4. 通知相关人员

**短期恢复 (15分钟内):**
1. 检查系统资源
2. 查看错误日志
3. 回滚到上一个稳定版本
4. 验证服务恢复

**根因分析 (1小时内):**
1. 分析日志文件
2. 检查配置变更
3. 确定问题根因
4. 制定永久解决方案

### 2. 性能严重下降

**立即响应:**
1. 监控系统资源使用
2. 检查数据库性能
3. 分析慢查询日志
4. 临时限流措施

**优化措施:**
1. 增加服务实例
2. 优化数据库查询
3. 启用缓存
4. 负载均衡调整

### 3. 数据库问题

**立即响应:**
1. 检查数据库连接
2. 验证数据完整性
3. 切换到备用数据库 (如有)
4. 停止写入操作 (如必要)

**恢复措施:**
1. 从备份恢复数据
2. 修复数据库问题
3. 验证数据一致性
4. 恢复正常服务

---

本故障排除指南涵盖了 FastGPT SSO 系统的主要故障场景和解决方案。在遇到问题时，请按照相应的诊断步骤进行排查，并根据具体情况选择合适的解决方案。如果问题仍然无法解决，请及时联系技术支持团队。